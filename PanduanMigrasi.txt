======================================================================
DOKUMEN SPESIFIKASI ARSITEKTUR DATABASE
Sistem Manajemen Bank Sampah Terpadu v2.0

Dokumen Revisi : 1.0  
Tanggal         : 26 Juli 2025  
Status          : FINAL

----------------------------------------------------------------------
1. PENDAHULUAN
----------------------------------------------------------------------

1.1. Tujuan Dokumen  
Dokumen ini berfungsi sebagai panduan teknis utama (Single Source of Truth) untuk struktur database sistem. Dokumen ini merinci setiap tabel, atribut, relasi, dan rationale desain untuk memastikan implementasi yang konsisten dan pemeliharaan yang terstruktur.

1.2. Filosofi Arsitektur  
- Modularitas: Sistem dibagi menjadi beberapa modul logis (Pengguna, Keuangan, Operasional, Komunitas) untuk mempermudah pengembangan dan pemeliharaan.  
- Integritas Data: Penggunaan Foreign Key Constraints dan tipe data yang tepat diutamakan untuk menjaga konsistensi dan validitas data.  
- Performa: Denormalisasi terkontrol (melalui tabel summary) diimplementasikan secara strategis untuk mengoptimalkan query yang sering diakses dan bersifat agregat.

----------------------------------------------------------------------
2. SPESIFIKASI TABEL DETAIL
----------------------------------------------------------------------

Legenda:  
PK = Primary Key  
FK = Foreign Key  
UQ = Unique Constraint  
IX = Indexed Column

---[ 2.1. Modul Manajemen Pengguna & Keuangan ]---

Tabel: users  
Tujuan: Akun Admin untuk mengelola sistem via panel Filament.
| Kolom     | Tipe Data     | Constraint      | Keterangan                    |
|-----------|---------------|-----------------|-------------------------------|
| id        | ULID          | PK              | Unique identifier untuk Admin |
| name      | VARCHAR(255)  |                 | Nama lengkap admin            |
| email     | VARCHAR(255)  | UQ, IX          | Alamat email, untuk login     |
| password  | VARCHAR(255)  |                 | Hash password (Bcrypt/Argon2) |
| created_at| TIMESTAMP     |                 |                               |
| updated_at| TIMESTAMP     |                 |                               |

Tabel: kartu_keluarga  
Tujuan: Entitas grup yang merepresentasikan satu keluarga.
| Kolom     | Tipe Data     | Constraint      | Keterangan                       |
|-----------|---------------|-----------------|----------------------------------|
| id        | ULID          | PK              | Unique identifier untuk KK       |
| nomor_kk  | VARCHAR(50)   | UQ, IX          | Nomor Kartu Keluarga             |
| created_at| TIMESTAMP     |                 |                                  |
| updated_at| TIMESTAMP     |                 |                                  |

Relasi: 1-to-1 dengan rekening, 1-to-many dengan nasabah.

Tabel: nasabah  
Tujuan: Data individu anggota bank sampah.
| Kolom            | Tipe Data     | Constraint      | Keterangan                       |
|------------------|---------------|-----------------|----------------------------------|
| id               | ULID          | PK              | Unique identifier untuk Nasabah  |
| kartu_keluarga_id| ULID          | FK, IX          | Merujuk ke kartu_keluarga(id)    |
| nama             | VARCHAR(255)  |                 | Nama lengkap nasabah             |
| nik              | VARCHAR(50)   | UQ, IX          | Nomor Induk Kependudukan         |
| created_at       | TIMESTAMP     |                 |                                  |
| updated_at       | TIMESTAMP     |                 |                                  |

Tabel: rekening  
Tujuan: "Buku Besar" per KK, menyimpan saldo akhir.
| Kolom            | Tipe Data      | Constraint       | Keterangan                          |
|------------------|----------------|------------------|-------------------------------------|
| id               | ULID           | PK               | Unique identifier untuk Rekening    |
| kartu_keluarga_id| ULID           | FK, UQ, IX       | Merujuk ke kartu_keluarga(id)       |
| balance          | DECIMAL(15,2)  |                  | Saldo uang terkini                  |
| points_balance   | BIGINT         |                  | Saldo poin terkini                  |
| created_at       | TIMESTAMP      |                  |                                     |
| updated_at       | TIMESTAMP      |                  |                                     |

Rationale: Denormalisasi untuk akses data super cepat.

Tabel: saldo_transactions & poin_transactions  
Tujuan: Ledger untuk semua mutasi uang & poin.
| Kolom             | Tipe Data     | Constraint       | Keterangan                        |
|-------------------|---------------|------------------|-----------------------------------|
| id                | ULID          | PK               | ID unik transaksi                 |
| rekening_id       | ULID          | FK, IX           | Merujuk ke rekening(id)           |
| amount            | DECIMAL/BIGINT|                  | Jumlah (+/-)                      |
| transactable_type | VARCHAR(255)  | IX               | Nama model sumber (polimorfik)    |
| transactable_id   | ULID          | IX               | ID sumber (polimorfik)            |
| description       | VARCHAR(255)  |                  | Deskripsi singkat transaksi       |
| created_at        | TIMESTAMP     |                  |                                   |
| updated_at        | TIMESTAMP     |                  |                                   |

---[ 2.2. Modul Operasional Bank Sampah ]---

Tabel: sampah  
Tujuan: Master data jenis sampah.
| Kolom         | Tipe Data     | Constraint | Keterangan                     |
|---------------|---------------|------------|--------------------------------|
| id            | ULID          | PK         | ID unik jenis sampah           |
| jenis_sampah  | VARCHAR(255)  | UQ         | Misal: "Botol Plastik PET"     |
| saldo_per_kg  | DECIMAL(15,2) |            | Harga beli per kg              |
| poin_per_kg   | INT           |            | Poin yang diberikan per kg     |

Tabel: setor_sampah  
Tujuan: Header transaksi penyetoran.
| Kolom                | Tipe Data     | Constraint | Keterangan                            |
|----------------------|---------------|------------|----------------------------------------|
| id                   | ULID          | PK         | ID unik kejadian setor                 |
| rekening_id          | ULID          | FK, IX     | Merujuk ke rekening(id)                |
| total_saldo_dihasilkan| DECIMAL(15,2)|            | Nilai agregat dicatat ke ledger        |
| total_poin_dihasilkan| BIGINT        |            | Poin agregat dicatat ke ledger         |
| created_at           | TIMESTAMP     |            |                                        |
| updated_at           | TIMESTAMP     |            |                                        |

Tabel: detail_setor_sampah  
Tujuan: Pivot detail dari setor_sampah.
| Kolom            | Tipe Data     | Constraint | Keterangan                        |
|------------------|---------------|------------|-----------------------------------|
| id               | BIGINT        | PK         |                                   |
| setor_sampah_id  | ULID          | FK, IX     | Merujuk ke setor_sampah(id)       |
| sampah_id        | ULID          | FK, IX     | Merujuk ke sampah(id)             |
| berat            | DECIMAL(8,2)  |            | Berat dalam kg                    |

Tabel: sampah_keluar  
Tujuan: Catat pengeluaran sampah.
| Kolom           | Tipe Data     | Constraint | Keterangan                      |
|-----------------|---------------|------------|---------------------------------|
| id              | ULID          | PK         | ID unik transaksi keluar        |
| sampah_id       | ULID          | FK, IX     | Merujuk ke sampah(id)           |
| berat_keluar    | DECIMAL(15,2) |            | Berat dikeluarkan (kg)          |
| tanggal_keluar  | DATE          | IX         | Tanggal keluarnya               |
| keterangan      | TEXT          | NULLABLE   | Catatan tambahan                |
| created_at      | TIMESTAMP     |            |                                 |
| updated_at      | TIMESTAMP     |            |                                 |

---[ 2.3. Modul Komunitas & Optimasi ]---

Tabel: umkm  
Tujuan: Profil usaha mikro nasabah.
| Kolom       | Tipe Data     | Constraint | Keterangan                        |
|-------------|---------------|------------|-----------------------------------|
| id          | ULID          | PK         |                                   |
| nasabah_id  | ULID          | FK, UQ, IX | Merujuk ke nasabah(id)            |
| nama_umkm   | VARCHAR(255)  |            |                                   |
| deskripsi   | TEXT          |            |                                   |

Tabel: postingan_umkm  
Tujuan: Katalog produk/jasa.
| Kolom           | Tipe Data     | Constraint | Keterangan                    |
|-----------------|---------------|------------|-------------------------------|
| id              | ULID          | PK         |                               |
| umkm_id         | ULID          | FK, IX     | Merujuk ke umkm(id)           |
| judul_postingan | VARCHAR(255)  |            |                               |
| harga           | DECIMAL(15,2) | NULLABLE   | Harga produk/jasa             |

Tabel: sampah_summaries  
Tujuan: Ringkasan harian berat masuk & keluar.
| Kolom             | Tipe Data     | Constraint     | Keterangan                        |
|-------------------|---------------|----------------|-----------------------------------|
| id                | BIGINT        | PK             |                                   |
| sampah_id         | ULID          | FK, IX         | Merujuk ke sampah(id)             |
| tanggal_summary   | DATE          | IX             | Tanggal data                      |
| total_berat_masuk | DECIMAL(15,2) |                | Dari detail_setor_sampah          |
| total_berat_keluar| DECIMAL(15,2) |                | Dari sampah_keluar                |
Constraint Unik: (sampah_id, tanggal_summary)

Rationale: Meningkatkan performa dengan menghindari query agregat mahal.

----------------------------------------------------------------------
3. ALUR DATA KRITIS: PROSES SETOR SAMPAH
----------------------------------------------------------------------

1. Admin (user) membuat record baru via Resource SetorSampah (rekening_id & repeater untuk detail).
2. Sistem memvalidasi input.
3. Transaksi database dimulai: DB::transaction(function () { ... });
4. Sistem loop untuk hitung total_saldo_dihasilkan dan total_poin_dihasilkan.
5. Insert ke tabel setor_sampah (header transaksi).
6. Insert ke detail_setor_sampah (pivot data jenis & berat).
7. Insert ke:
   - saldo_transactions (positif, morph ke setor_sampah)
   - poin_transactions (positif, morph ke setor_sampah)
8. Update balance dan points_balance di rekening.
9. Jika semua berhasil, commit. Jika gagal, rollback.

----------------------------------------------------------------------
4. KESIMPULAN
----------------------------------------------------------------------

Arsitektur ini menyediakan fondasi kuat dan modular, siap dikembangkan lebih lanjut. Desain ledger & summary tables memastikan performa tinggi dan pemeliharaan jangka panjang.

======================== AKHIR DOKUMEN ========================
